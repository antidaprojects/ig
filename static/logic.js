var InstaClient=function(t){this._lid=t.lid,this._lat=t.lat,this._lng=t.lng,this._token="205777063.2c74185.6658cbe7f46141fb86978de07e30e94b",this._longdistance=t.longdistance||!1,this._loaded=[],this._template='<li class="instagram-photo-wrapper"><a href="{href}" target="_blank"><img src="{img}" class="instagram-photo" onload="photoLoaded(this);"></a><div class="instagram-photo-desc"><em>{username}</em><br/><span class="instagram-photo-time" data-time="{timestamp}">{time}</span> ago.</div></li>',this._call=function(t,a){return $.ajax({type:"GET",dataType:"jsonp",url:t,success:a})}};InstaClient.prototype.getUser=function(t,a){var e=t||"self";this._call("https://api.instagram.com/v1/users/"+e+"/?access_token="+this._token,a)},InstaClient.prototype.getFollowers=function(t,a){var e=t||"self";this._call("https://api.instagram.com/v1/users/"+e+"/followed-by?access_token="+this._token,a)},InstaClient.prototype.getPhotos=function(t,a){var e=t||"self";this._call("https://api.instagram.com/v1/users/"+e+"/media/recent/?access_token="+this._token,a)},InstaClient.prototype.getLikes=function(t,a){this._call("https://api.instagram.com/v1/media/"+t+"/likes?access_token="+this._token,a)},InstaClient.prototype._locHandler=function(t,a){var e=this;if(t&&t.data){var n=null,o=document.getElementById("photos-container"),i=new Date;t.data.length?window.lastTimestamp=t.data[0].created_time:0===t.data.length&&0===$(".instagram-photo-wrapper").length&&$("#photos-container").html('<p class="ta-c">Location has no photos yet..<p>'),$(".instagram-photo-time").each(function(){$(this).text(getPhotoTime($(this).data("time"),i))}),$.each(t.data,function(t,s){-1===e._loaded.indexOf(s.id)&&(n=e._template.replace("{href}",s.link),n=n.replace("{img}",s.images.standard_resolution.url),n=n.replace("{username}",s.user.username),n=n.replace("{time}",getPhotoTime(s.created_time,i)),n=n.replace("{timestamp}",s.created_time),a===!0?o.innerHTML=n+o.innerHTML:o.innerHTML+=n,e._loaded.push(s.id))})}else alert("Something goes wrong. Sorry, it's beta version..")},InstaClient.prototype.getPhotosInLocation=function(t){var a=this,e=this._lid?"https://api.instagram.com/v1/locations/"+this._lid+"/media/recent?access_token="+this._token:"https://api.instagram.com/v1/media/search?lat="+this._lat+"&lng="+this._lng+"&access_token="+this._token;window.lastTimestamp&&(e+="&min_timestamp="+window.lastTimestamp),this._longdistance===!0&&(e+="&distance=3000"),this._call(e,function(e){a._locHandler(e,t)})},InstaClient.prototype.morePhotosInLocation=function(){var t=$(".instagram-photo-time").last().data("time");if(void 0!=t&&!window._moreLoading){var a=this,e=this._lid?"https://api.instagram.com/v1/locations/"+this._lid+"/media/recent?access_token="+this._token+"&max_timestamp="+t:"https://api.instagram.com/v1/media/search?lat="+this._lat+"&lng="+this._lng+"&access_token="+this._token+"&max_timestamp="+t;this._longdistance===!0&&(e+="&distance=1000"),window._moreLoading=this._call(e,function(t){a._locHandler(t,!1),window._moreLoading=void 0})}},InstaClient.prototype.findNearLocations=function(){var t="https://api.instagram.com/v1/locations/search?lat="+this._lat+"&lng="+this._lng+"&access_token="+this._token;this._call(t,function(t){if(t&&t.data){var a=document.getElementById("near-locs");$.each(t.data,function(t,e){a.innerHTML+='<li><a href="/ig/watch/#lid='+e.id+"&lat="+e.latitude+"&lng="+e.longitude+"&name="+e.name+'">'+e.name+"</a></li>"}),$(".alert-loc").fadeIn()}})};var getHashParams=function(){var t=location.hash;if(""==t)return{};for(var a=t.substring(1).split("&"),e=null,n={},o=0;o<a.length;++o)e=a[o].split("="),2===e.length&&(n[e[0]]=e[1]);return n},photoLoaded=function(t){t&&t.classList.add("ready")},getPhotoTime=function(t,a){if(!t||!a)return"0 s";var e=Math.round((a-new Date(1e3*t))/1e3);return 60>e?e+=" second(s)":e=e>=60&&3600>e?Math.round(e/60)+" minute(s)":e>=3600&&86400>e?Math.round(e/3600)+" hour(s)":Math.round(e/86400)+" day(s)",e},findLocation=function(t){var a=void 0;return $.ajax({url:"http://maps.google.com/maps/api/geocode/json?sensor=false&address="+t,async:!1,type:"GET",success:function(t){if(t&&t.results&&t.results.length){var e=t.results[0];a={addr:e.formatted_address,lat:e.geometry.location.lat,lng:e.geometry.location.lng}}}}),a},launchWatcher=function(){var t=getHashParams();if(t){var a,e,n,o,i=!0;if(t.loc){var s=findLocation(t.loc);s?(e=s.lat,n=s.lng,o=s.addr):location="index.html"}else t.lid&&(a=t.lid,e=t.lat,n=t.lng,o=t.name);o&&$("#location-lead").text(o);var l=new InstaClient({lid:a,lat:e,lng:n,longdistance:i});l.getPhotosInLocation(!1),e&&n&&l.findNearLocations(),setInterval(function(){l.getPhotosInLocation(!0)},2e3),window.onscroll=function(){windowScroll(l)}}window.onhashchange=function(){location.reload()},$("#place-modal").on("shown.bs.modal",function(){$("#place-to-go").focus()})},windowScroll=function(t){var a=document.body,e=document.documentElement,n=Math.max(a.scrollHeight,a.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight),o=window.scrollY+e.clientHeight,i=o/n;i>.8&&t.morePhotosInLocation()},place=function(t){var a=$("#place-to-go");return a.val(t),a.focus(),!1},goTo=function(){var t=$("#place-to-go").val();""!=t&&findLocation(t)&&(location="/ig/watch/#loc="+t,location.reload())},placeUpdate=function(t){13===t.keyCode&&goTo()},showNearLocs=function(){$(".near-locs").show()};